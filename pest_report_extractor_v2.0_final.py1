#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è™«å®³æƒ…å†µè‡ªåŠ¨æå–å·¥å…· v2.0
åŠŸèƒ½ï¼šä»PDFä¸­æå–è™«å®³æ•°æ®ï¼Œè½¬æ¢ä¸ºExcelæ ¼å¼ï¼Œç”Ÿæˆåˆ†ææŠ¥å‘Šï¼Œå¹¶è¿›è¡Œæ•°æ®éªŒè¯

ä½¿ç”¨æ–¹æ³•ï¼š
1. GUIæ¨¡å¼ï¼ˆmacOS/Windowsï¼‰ï¼šç›´æ¥è¿è¡Œ python pest_report_extractor.py
2. å‘½ä»¤è¡Œæ¨¡å¼ï¼špython pest_report_extractor.py --pdf <pdfæ–‡ä»¶è·¯å¾„> [--output <è¾“å‡ºç›®å½•>] [--report]
3. å‘½ä»¤è¡Œæ¨¡å¼ç¤ºä¾‹ï¼špython pest_report_extractor.py --pdf report.pdf --output ~/Desktop --report
"""

import re
import sys
import argparse
from pathlib import Path
import pdfplumber
from openpyxl import Workbook, load_workbook
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
import pandas as pd
from datetime import datetime
import subprocess
import platform

# å°è¯•å¯¼å…¥tkinterï¼ˆç”¨äºGUIæ¨¡å¼ï¼‰
try:
    import tkinter as tk
    from tkinter import filedialog, messagebox
    HAS_GUI = True
except ImportError:
    HAS_GUI = False


class PestReportExtractor:
    """è™«å®³æŠ¥å‘Šæå–å™¨"""
    
    def __init__(self):
        self.pdf_path = None
        self.pest_data = []
        self.output_path = None
        
    def select_file(self, file_type="pdf"):
        """é€‰æ‹©æ–‡ä»¶å¯¹è¯æ¡†ï¼ˆGUIæ¨¡å¼ï¼‰"""
        if not HAS_GUI:
            print("âŒ GUIæ¨¡å¼ä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šæ–‡ä»¶")
            return None
            
        root = tk.Tk()
        root.withdraw()
        root.lift()
        root.attributes('-topmost', True)
        
        if file_type == "pdf":
            file_path = filedialog.askopenfilename(
                title="é€‰æ‹©è™«å®³æŠ¥å‘ŠPDFæ–‡ä»¶",
                filetypes=[("PDFæ–‡ä»¶", "*.pdf"), ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
            )
        else:
            file_path = filedialog.askopenfilename(
                title="é€‰æ‹©å‚è€ƒæ ¼å¼æˆªå›¾ï¼ˆå¯é€‰ï¼‰",
                filetypes=[("å›¾ç‰‡æ–‡ä»¶", "*.png *.jpg *.jpeg"), ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
            )
        
        root.destroy()
        return file_path
    
    def extract_pest_data_from_pdf(self, pdf_path):
        """ä»PDFä¸­æå–è™«å®³æ•°æ®"""
        print(f"\nğŸ“„ æ­£åœ¨è¯»å–PDFæ–‡ä»¶: {Path(pdf_path).name}")
        self.pest_data = []
        
        try:
            with pdfplumber.open(pdf_path) as pdf:
                full_text = ""
                for page in pdf.pages:
                    full_text += page.extract_text() + "\n"
                
                # æå–è™«å®³æƒ…å†µéƒ¨åˆ†
                pest_section = self._extract_pest_section(full_text)
                
                if not pest_section:
                    print("âŒ æœªæ‰¾åˆ°è™«å®³æƒ…å†µæ•°æ®")
                    return False
                
                # è§£æè™«å®³è®°å½•
                self._parse_pest_records(pest_section)
                
                print(f"âœ… æˆåŠŸæå– {len(self.pest_data)} æ¡è™«å®³æ´»åŠ¨è®°å½•")
                return True
                
        except Exception as e:
            print(f"âŒ PDFè¯»å–å¤±è´¥: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
    
    def _extract_pest_section(self, text):
        """æå–è™«å®³æƒ…å†µéƒ¨åˆ†çš„æ–‡æœ¬"""
        # æŸ¥æ‰¾è™«å®³æƒ…å†µå¼€å§‹å’Œç»“æŸçš„æ ‡è®°
        start_marker = "è™«å®³æƒ…å†µ"
        end_marker = "æœåŠ¡æ€»ç»“"
        
        start_idx = text.find(start_marker)
        end_idx = text.find(end_marker)
        
        if start_idx != -1 and end_idx != -1:
            return text[start_idx:end_idx]
        return None
    
    def _parse_pest_records(self, text):
        """è§£æè™«å®³è®°å½•"""
        # æ¸…ç†æ–‡æœ¬ä¸­çš„ç‰¹æ®Šå­—ç¬¦
        text = text.replace('\x01', ' ')
        
        # æŒ‰è¡Œåˆ†å‰²
        lines = text.split('\n')
        
        for i, line in enumerate(lines):
            line = line.strip()
            
            # åŒ¹é…è™«å®³ç±»å‹å’Œæ•°é‡ï¼šå¦‚ "ç»¿åŒ–é£è™« å‘ç°è™«å®³æ´»åŠ¨ - 5"
            # æ”¯æŒå¤šç§åˆ†éš”ç¬¦å’Œç©ºæ ¼
            pest_match = re.match(r'^([\u4e00-\u9fa5]+)\s+å‘ç°è™«å®³æ´»åŠ¨\s*[-â€“â€”]\s*(\d+)', line)
            if pest_match:
                pest_type = pest_match.group(1)
                count = int(pest_match.group(2))
                
                # æŸ¥æ‰¾ä¸‹ä¸€è¡Œçš„å»ºç­‘ç‰©ä¿¡æ¯
                if i + 1 < len(lines):
                    next_line = lines[i + 1].strip()
                    # æ”¯æŒæ›´çµæ´»çš„æ¨¡å¼åŒ¹é…
                    building_match = re.search(
                        r'å»ºç­‘ç‰©:\s*([^,]+),\s*æ¥¼å±‚:\s*([^,]+),\s*éƒ¨é—¨:\s*([^,]+),\s*æ£€æŸ¥/å‘ç°ç›‘æµ‹ç‚¹ä½:\s*(.+)',
                        next_line
                    )
                    
                    if building_match:
                        building = building_match.group(1).strip()
                        floor = building_match.group(2).strip()
                        department = building_match.group(3).strip()
                        location = building_match.group(4).strip()
                        
                        # æ·»åŠ è®°å½•
                        self.pest_data.append({
                            'å»ºç­‘ç‰©': building,
                            'æ¥¼å±‚': floor,
                            'éƒ¨é—¨': department,
                            'æ£€æŸ¥/å‘ç°ç›‘æµ‹ç‚¹ä½': location,
                            'è™«å®³ç±»å‹': pest_type,
                            'å‘ç°è™«å®³æ´»åŠ¨': count
                        })
    
    def create_excel(self, output_dir=None):
        """åˆ›å»ºExcelæ–‡ä»¶"""
        if not self.pest_data:
            print("âŒ æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º")
            return False
        
        print("\nğŸ“Š æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶...")
        
        # åˆ›å»ºå·¥ä½œç°¿
        wb = Workbook()
        ws = wb.active
        ws.title = "è™«å®³æƒ…å†µ"
        
        # è¡¨å¤´
        headers = ["å»ºç­‘ç‰©", "æ¥¼å±‚", "éƒ¨é—¨", "æ£€æŸ¥/å‘ç°ç›‘æµ‹ç‚¹ä½", "è™«å®³ç±»å‹", "å‘ç°è™«å®³æ´»åŠ¨"]
        ws.append(headers)
        
        # è®¾ç½®è¡¨å¤´æ ·å¼
        header_fill = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
        header_font = Font(bold=True, size=11)
        border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )
        
        for cell in ws[1]:
            cell.fill = header_fill
            cell.font = header_font
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.border = border
        
        # æ·»åŠ æ•°æ®
        for record in self.pest_data:
            ws.append([
                record['å»ºç­‘ç‰©'],
                record['æ¥¼å±‚'],
                record['éƒ¨é—¨'],
                record['æ£€æŸ¥/å‘ç°ç›‘æµ‹ç‚¹ä½'],
                record['è™«å®³ç±»å‹'],
                record['å‘ç°è™«å®³æ´»åŠ¨']
            ])
        
        # è®¾ç½®æ•°æ®è¡Œæ ·å¼
        for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
            for cell in row:
                cell.border = border
                cell.alignment = Alignment(horizontal='center', vertical='center')
        
        # è®¾ç½®åˆ—å®½
        ws.column_dimensions['A'].width = 15
        ws.column_dimensions['B'].width = 12
        ws.column_dimensions['C'].width = 15
        ws.column_dimensions['D'].width = 20
        ws.column_dimensions['E'].width = 15
        ws.column_dimensions['F'].width = 15
        
        # ä¿å­˜æ–‡ä»¶
        if output_dir is None:
            output_dir = Path.home() / "Desktop"
        else:
            output_dir = Path(output_dir)
        
        output_dir.mkdir(parents=True, exist_ok=True)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"è™«å®³æƒ…å†µæŠ¥å‘Š_{timestamp}.xlsx"
        self.output_path = output_dir / filename
        
        wb.save(self.output_path)
        print(f"âœ… Excelæ–‡ä»¶å·²ä¿å­˜: {self.output_path}")
        return True
    
    def generate_analysis_report(self):
        """ç”Ÿæˆåˆ†ææŠ¥å‘Šä½œä¸ºæ–°çš„å·¥ä½œè¡¨"""
        if not self.output_path or not self.output_path.exists():
            print("âŒ Excelæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Š")
            return False
        
        print("\nğŸ“ˆ æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...")
        
        # è¯»å–Excelæ–‡ä»¶
        wb = load_workbook(self.output_path)
        df = pd.read_excel(self.output_path, sheet_name='è™«å®³æƒ…å†µ')
        
        # åˆ›å»ºåˆ†ææŠ¥å‘Šå·¥ä½œè¡¨
        if "æ•°æ®åˆ†ææŠ¥å‘Š" in wb.sheetnames:
            del wb["æ•°æ®åˆ†ææŠ¥å‘Š"]
        ws_report = wb.create_sheet("æ•°æ®åˆ†ææŠ¥å‘Š", 0)
        
        # è®¡ç®—ç»Ÿè®¡æ•°æ®
        total_records = len(df)
        total_pests = df['å‘ç°è™«å®³æ´»åŠ¨'].sum()
        avg_density = total_pests / total_records if total_records > 0 else 0
        max_single = df['å‘ç°è™«å®³æ´»åŠ¨'].max()
        
        # è™«å®³ç±»å‹ç»Ÿè®¡
        pest_type_stats = df.groupby('è™«å®³ç±»å‹').agg({
            'è™«å®³ç±»å‹': 'count',
            'å‘ç°è™«å®³æ´»åŠ¨': 'sum'
        }).rename(columns={'è™«å®³ç±»å‹': 'è®°å½•æ•°', 'å‘ç°è™«å®³æ´»åŠ¨': 'æ€»æ•°é‡'})
        pest_type_stats['å æ¯”'] = (pest_type_stats['æ€»æ•°é‡'] / total_pests * 100).round(1)
        pest_type_stats = pest_type_stats.sort_values('æ€»æ•°é‡', ascending=False)
        
        # å»ºç­‘ç‰©ç»Ÿè®¡
        building_stats = df.groupby('å»ºç­‘ç‰©').agg({
            'å»ºç­‘ç‰©': 'count',
            'å‘ç°è™«å®³æ´»åŠ¨': 'sum'
        }).rename(columns={'å»ºç­‘ç‰©': 'è®°å½•æ•°', 'å‘ç°è™«å®³æ´»åŠ¨': 'æ€»æ•°é‡'})
        building_stats['å æ¯”'] = (building_stats['æ€»æ•°é‡'] / total_pests * 100).round(1)
        building_stats = building_stats.sort_values('æ€»æ•°é‡', ascending=False)
        
        # TOP 10é«˜å±åŒºåŸŸ
        top10 = df.nlargest(10, 'å‘ç°è™«å®³æ´»åŠ¨')
        
        # å¼€å§‹ç»˜åˆ¶æŠ¥å‘Š
        self._draw_overview_section(ws_report, total_records, total_pests, avg_density, max_single)
        self._draw_pest_type_stats(ws_report, pest_type_stats, 10)
        self._draw_building_stats(ws_report, building_stats, 18 + len(pest_type_stats))
        self._draw_top10_section(ws_report, top10, 26 + len(pest_type_stats) + len(building_stats))
        
        # ä¿å­˜æ–‡ä»¶
        wb.save(self.output_path)
        print(f"âœ… åˆ†ææŠ¥å‘Šå·²æ·»åŠ åˆ°å·¥ä½œè¡¨: æ•°æ®åˆ†ææŠ¥å‘Š")
        return True
    
    def _draw_overview_section(self, ws, total_records, total_pests, avg_density, max_single):
        """ç»˜åˆ¶æ•°æ®æ¦‚è§ˆéƒ¨åˆ†"""
        # æ ‡é¢˜
        ws.merge_cells('A1:G2')
        title_cell = ws['A1']
        title_cell.value = "è™«å®³æƒ…å†µæ•°æ®æ¦‚è§ˆ"
        title_cell.font = Font(size=16, bold=True)
        title_cell.alignment = Alignment(horizontal='left', vertical='center')
        
        # æ¦‚è§ˆå¡ç‰‡
        overview_data = [
            ('æ€»è®°å½•æ•°', f'{total_records} æ¡'),
            ('è™«å®³æ€»æ•°', f'{total_pests} åª'),
            ('å¹³å‡å¯†åº¦', f'{avg_density:.1f} åª/å¤„'),
            ('âš ï¸ æœ€å¤§å•ç‚¹', f'{max_single} åª')
        ]
        
        row = 4
        for i, (label, value) in enumerate(overview_data):
            col = i * 2 + 1
            
            # æ ‡ç­¾
            label_cell = ws.cell(row=row, column=col)
            label_cell.value = label
            label_cell.font = Font(size=11, bold=True)
            label_cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # å€¼
            value_cell = ws.cell(row=row+1, column=col)
            value_cell.value = value
            value_cell.font = Font(size=13, bold=True)
            value_cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # å¦‚æœæ˜¯æœ€å¤§å•ç‚¹ï¼Œé«˜äº®æ˜¾ç¤º
            if 'âš ï¸' in label:
                value_cell.fill = PatternFill(start_color="FFF3CD", end_color="FFF3CD", fill_type="solid")
        
        # è®¾ç½®åˆ—å®½
        for col in range(1, 9):
            ws.column_dimensions[get_column_letter(col)].width = 15
    
    def _draw_pest_type_stats(self, ws, pest_type_stats, start_row):
        """ç»˜åˆ¶è™«å®³ç±»å‹ç»Ÿè®¡è¡¨"""
        # å°æ ‡é¢˜
        row = start_row
        ws.merge_cells(f'A{row}:D{row}')
        subtitle_cell = ws[f'A{row}']
        subtitle_cell.value = "è™«å®³ç±»å‹ç»Ÿè®¡"
        subtitle_cell.font = Font(size=13, bold=True)
        subtitle_cell.alignment = Alignment(horizontal='left', vertical='center')
        subtitle_cell.fill = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid")
        
        # è¡¨å¤´
        row += 1
        headers = ['è™«å®³ç±»å‹', 'è®°å½•æ•°', 'æ€»æ•°é‡ï¼ˆåªï¼‰', 'å æ¯”']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=row, column=col)
            cell.value = header
            cell.font = Font(bold=True, size=11)
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
            cell.border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
        
        # æ•°æ®è¡Œ
        for pest_type, data in pest_type_stats.iterrows():
            row += 1
            values = [pest_type, int(data['è®°å½•æ•°']), int(data['æ€»æ•°é‡']), f"{data['å æ¯”']}%"]
            for col, value in enumerate(values, 1):
                cell = ws.cell(row=row, column=col)
                cell.value = value
                cell.alignment = Alignment(horizontal='center', vertical='center')
                cell.border = Border(
                    left=Side(style='thin'),
                    right=Side(style='thin'),
                    top=Side(style='thin'),
                    bottom=Side(style='thin')
                )
    
    def _draw_building_stats(self, ws, building_stats, start_row):
        """ç»˜åˆ¶å»ºç­‘ç‰©ç»Ÿè®¡è¡¨"""
        # å°æ ‡é¢˜
        row = start_row
        ws.merge_cells(f'A{row}:D{row}')
        subtitle_cell = ws[f'A{row}']
        subtitle_cell.value = "å»ºç­‘ç‰©è™«å®³ç»Ÿè®¡"
        subtitle_cell.font = Font(size=13, bold=True)
        subtitle_cell.alignment = Alignment(horizontal='left', vertical='center')
        subtitle_cell.fill = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid")
        
        # è¡¨å¤´
        row += 1
        headers = ['å»ºç­‘ç‰©', 'è®°å½•æ•°', 'æ€»æ•°é‡ï¼ˆåªï¼‰', 'å æ¯”']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=row, column=col)
            cell.value = header
            cell.font = Font(bold=True, size=11)
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
            cell.border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
        
        # æ•°æ®è¡Œ
        for building, data in building_stats.iterrows():
            row += 1
            values = [building, int(data['è®°å½•æ•°']), int(data['æ€»æ•°é‡']), f"{data['å æ¯”']}%"]
            for col, value in enumerate(values, 1):
                cell = ws.cell(row=row, column=col)
                cell.value = value
                cell.alignment = Alignment(horizontal='center', vertical='center')
                cell.border = Border(
                    left=Side(style='thin'),
                    right=Side(style='thin'),
                    top=Side(style='thin'),
                    bottom=Side(style='thin')
                )
    
    def _draw_top10_section(self, ws, top10_df, start_row):
        """ç»˜åˆ¶é«˜å±åŒºåŸŸTOP10è¡¨"""
        # æ ‡é¢˜
        row = start_row
        ws.merge_cells(f'A{row}:G{row}')
        title_cell = ws[f'A{row}']
        title_cell.value = "é«˜å±åŒºåŸŸåˆ†æ - TOP 10"
        title_cell.font = Font(size=14, bold=True)
        title_cell.alignment = Alignment(horizontal='left', vertical='center')
        title_cell.fill = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid")
        
        # è¡¨å¤´
        row += 1
        headers = ['æ’å', 'å»ºç­‘ç‰©', 'æ¥¼å±‚', 'éƒ¨é—¨', 'ç›‘æµ‹ç‚¹ä½', 'è™«å®³ç±»å‹', 'æ•°é‡']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=row, column=col)
            cell.value = header
            cell.font = Font(bold=True, size=11)
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
            cell.font = Font(bold=True, size=11, color="FFFFFF")
            cell.border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
        
        # æ•°æ®è¡Œ
        for idx, record in top10_df.iterrows():
            row += 1
            rank = row - start_row - 1
            values = [
                rank,
                record['å»ºç­‘ç‰©'],
                record['æ¥¼å±‚'],
                record['éƒ¨é—¨'],
                record['æ£€æŸ¥/å‘ç°ç›‘æµ‹ç‚¹ä½'],
                record['è™«å®³ç±»å‹'],
                int(record['å‘ç°è™«å®³æ´»åŠ¨'])
            ]
            
            for col, value in enumerate(values, 1):
                cell = ws.cell(row=row, column=col)
                cell.value = value
                cell.alignment = Alignment(horizontal='center', vertical='center')
                cell.border = Border(
                    left=Side(style='thin'),
                    right=Side(style='thin'),
                    top=Side(style='thin'),
                    bottom=Side(style='thin')
                )
                
                # å‰ä¸‰åé«˜äº®
                if rank <= 3:
                    cell.fill = PatternFill(start_color="FFF3CD", end_color="FFF3CD", fill_type="solid")
        
        # è®¾ç½®åˆ—å®½
        ws.column_dimensions['A'].width = 8
        ws.column_dimensions['E'].width = 18
        ws.column_dimensions['G'].width = 10
    
    def verify_data(self):
        """éªŒè¯ç”Ÿæˆçš„Excelæ•°æ®"""
        if not self.output_path or not self.output_path.exists():
            print("âŒ Excelæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯")
            return False
        
        print("\nğŸ” å¼€å§‹éªŒè¯æ•°æ®...")
        
        # è¯»å–ç”Ÿæˆçš„Excel
        df = pd.read_excel(self.output_path, sheet_name='è™«å®³æƒ…å†µ')
        
        # éªŒè¯1: è®°å½•æ•°é‡
        print(f"\n1ï¸âƒ£ è®°å½•æ•°é‡éªŒè¯:")
        print(f"   æå–çš„åŸå§‹æ•°æ®: {len(self.pest_data)} æ¡")
        print(f"   Excelæ–‡ä»¶ä¸­æ•°æ®: {len(df)} æ¡")
        if len(self.pest_data) == len(df):
            print("   âœ… æ•°é‡ä¸€è‡´")
        else:
            print("   âŒ æ•°é‡ä¸ä¸€è‡´")
            return False
        
        # éªŒè¯2: å­—æ®µå®Œæ•´æ€§
        print(f"\n2ï¸âƒ£ å­—æ®µå®Œæ•´æ€§éªŒè¯:")
        expected_columns = ["å»ºç­‘ç‰©", "æ¥¼å±‚", "éƒ¨é—¨", "æ£€æŸ¥/å‘ç°ç›‘æµ‹ç‚¹ä½", "è™«å®³ç±»å‹", "å‘ç°è™«å®³æ´»åŠ¨"]
        actual_columns = df.columns.tolist()
        if expected_columns == actual_columns:
            print("   âœ… æ‰€æœ‰å­—æ®µå®Œæ•´")
        else:
            print(f"   âŒ å­—æ®µä¸åŒ¹é…")
            print(f"   æœŸæœ›: {expected_columns}")
            print(f"   å®é™…: {actual_columns}")
            return False
        
        # éªŒè¯3: æ•°æ®å®Œæ•´æ€§ï¼ˆæ— ç©ºå€¼ï¼‰
        print(f"\n3ï¸âƒ£ æ•°æ®å®Œæ•´æ€§éªŒè¯:")
        null_counts = df.isnull().sum()
        if null_counts.sum() == 0:
            print("   âœ… æ— ç©ºå€¼æ•°æ®")
        else:
            print("   âš ï¸ å‘ç°ç©ºå€¼:")
            for col, count in null_counts[null_counts > 0].items():
                print(f"   {col}: {count} ä¸ªç©ºå€¼")
        
        # éªŒè¯4: é€æ¡å¯¹æ¯”
        print(f"\n4ï¸âƒ£ é€æ¡æ•°æ®éªŒè¯:")
        all_match = True
        mismatches = []
        
        for i, (original, excel_row) in enumerate(zip(self.pest_data, df.to_dict('records')), 1):
            for key in original.keys():
                if str(original[key]) != str(excel_row[key]):
                    all_match = False
                    mismatches.append({
                        'row': i,
                        'field': key,
                        'original': original[key],
                        'excel': excel_row[key]
                    })
        
        if all_match:
            print("   âœ… æ‰€æœ‰è®°å½•éªŒè¯é€šè¿‡")
        else:
            print(f"   âŒ å‘ç° {len(mismatches)} å¤„ä¸åŒ¹é…:")
            for mm in mismatches[:5]:  # åªæ˜¾ç¤ºå‰5ä¸ª
                print(f"      ç¬¬{mm['row']}æ¡ - {mm['field']}: {mm['original']} != {mm['excel']}")
            if len(mismatches) > 5:
                print(f"      ...è¿˜æœ‰ {len(mismatches)-5} å¤„ä¸åŒ¹é…")
        
        # éªŒè¯5: ç»Ÿè®¡ä¿¡æ¯
        print(f"\n5ï¸âƒ£ æ•°æ®ç»Ÿè®¡éªŒè¯:")
        print(f"   å»ºç­‘ç‰©åˆ†å¸ƒ:")
        for building, count in df['å»ºç­‘ç‰©'].value_counts().items():
            print(f"   - {building}: {count} æ¡")
        
        print(f"\n   è™«å®³ç±»å‹åˆ†å¸ƒ:")
        for pest_type, count in df['è™«å®³ç±»å‹'].value_counts().items():
            print(f"   - {pest_type}: {count} æ¬¡")
        
        print(f"\n   è™«å®³æ´»åŠ¨æ€»æ•°: {df['å‘ç°è™«å®³æ´»åŠ¨'].sum()}")
        
        print(f"\nâœ… æ•°æ®éªŒè¯å®Œæˆï¼")
        return True
    
    def run(self, pdf_path=None, output_dir=None, auto_open=False, generate_report=False):
        """è¿è¡Œå®Œæ•´æµç¨‹
        
        Args:
            pdf_path: PDFæ–‡ä»¶è·¯å¾„ï¼ˆå¦‚æœä¸ºNoneåˆ™å¼¹å‡ºé€‰æ‹©å¯¹è¯æ¡†ï¼‰
            output_dir: è¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸ºNoneåˆ™ä½¿ç”¨æ¡Œé¢ï¼‰
            auto_open: æ˜¯å¦è‡ªåŠ¨æ‰“å¼€ç”Ÿæˆçš„æ–‡ä»¶
            generate_report: æ˜¯å¦ç”Ÿæˆåˆ†ææŠ¥å‘Š
        """
        print("=" * 60)
        print("ğŸ› è™«å®³æƒ…å†µæ•°æ®æå–å·¥å…· v2.0")
        print("=" * 60)
        
        # 1. è·å–PDFæ–‡ä»¶
        if pdf_path is None:
            print("\nğŸ“ æ­¥éª¤1: é€‰æ‹©PDFæ–‡ä»¶")
            pdf_path = self.select_file("pdf")
            
            if not pdf_path:
                print("âŒ æœªé€‰æ‹©PDFæ–‡ä»¶ï¼Œç¨‹åºé€€å‡º")
                return False
        else:
            print(f"\nğŸ“ æ­¥éª¤1: ä½¿ç”¨PDFæ–‡ä»¶: {Path(pdf_path).name}")
            if not Path(pdf_path).exists():
                print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {pdf_path}")
                return False
        
        self.pdf_path = pdf_path
        
        # 2. æå–æ•°æ®
        print("\nğŸ“Š æ­¥éª¤2: æå–è™«å®³æ•°æ®")
        if not self.extract_pest_data_from_pdf(pdf_path):
            return False
        
        # 3. ç”ŸæˆExcel
        print("\nğŸ’¾ æ­¥éª¤3: ç”ŸæˆExcelæ–‡ä»¶")
        if not self.create_excel(output_dir):
            return False
        
        # 4. è¯¢é—®æ˜¯å¦ç”ŸæˆæŠ¥å‘Šï¼ˆGUIæ¨¡å¼ä¸”æœªæŒ‡å®šï¼‰
        if not generate_report and HAS_GUI and pdf_path is None:
            root = tk.Tk()
            root.withdraw()
            root.lift()
            root.attributes('-topmost', True)
            
            generate_report = messagebox.askyesno(
                "ç”Ÿæˆåˆ†ææŠ¥å‘Š",
                "æ˜¯å¦ç”Ÿæˆæ•°æ®åˆ†ææŠ¥å‘Šï¼Ÿ\n\næŠ¥å‘Šå°†åŒ…å«ï¼š\n- æ•°æ®æ¦‚è§ˆ\n- è™«å®³ç±»å‹ç»Ÿè®¡\n- å»ºç­‘ç‰©ç»Ÿè®¡\n- é«˜å±åŒºåŸŸTOP10"
            )
            
            root.destroy()
        
        # 5. ç”Ÿæˆåˆ†ææŠ¥å‘Š
        if generate_report:
            print("\nğŸ“ˆ æ­¥éª¤4: ç”Ÿæˆåˆ†ææŠ¥å‘Š")
            self.generate_analysis_report()
        
        # 6. éªŒè¯æ•°æ®
        print(f"\nğŸ” æ­¥éª¤{'5' if generate_report else '4'}: éªŒè¯æ•°æ®")
        self.verify_data()
        
        print("\n" + "=" * 60)
        print("âœ… æ‰€æœ‰æ­¥éª¤å®Œæˆï¼")
        print(f"ğŸ“ æ–‡ä»¶ä½ç½®: {self.output_path}")
        if generate_report:
            print("ğŸ“Š åˆ†ææŠ¥å‘Šå·²åŒ…å«åœ¨Excelæ–‡ä»¶ä¸­")
        print("=" * 60)
        
        # è¯¢é—®æ˜¯å¦æ‰“å¼€æ–‡ä»¶ï¼ˆä»…GUIæ¨¡å¼ï¼‰
        if HAS_GUI and not auto_open and pdf_path is None:
            root = tk.Tk()
            root.withdraw()
            root.lift()
            root.attributes('-topmost', True)
            
            result = messagebox.askyesno(
                "å®Œæˆ",
                f"æ•°æ®æå–å®Œæˆï¼\n\nå…±æå– {len(self.pest_data)} æ¡è™«å®³è®°å½•\n{'å·²ç”Ÿæˆåˆ†ææŠ¥å‘Š' if generate_report else ''}\n\næ˜¯å¦æ‰“å¼€Excelæ–‡ä»¶ï¼Ÿ"
            )
            
            root.destroy()
            
            if result:
                self._open_file(self.output_path)
        elif auto_open:
            self._open_file(self.output_path)
        
        return True
    
    def _open_file(self, file_path):
        """ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç¨‹åºæ‰“å¼€æ–‡ä»¶"""
        try:
            system = platform.system()
            if system == 'Darwin':  # macOS
                subprocess.run(['open', str(file_path)])
            elif system == 'Windows':
                subprocess.run(['start', str(file_path)], shell=True)
            else:  # Linux
                subprocess.run(['xdg-open', str(file_path)])
        except Exception as e:
            print(f"âš ï¸ æ— æ³•è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶: {e}")


def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description='è™«å®³æƒ…å†µè‡ªåŠ¨æå–å·¥å…· v2.0',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹ï¼š
  GUIæ¨¡å¼ï¼ˆå¼¹å‡ºæ–‡ä»¶é€‰æ‹©æ¡†ï¼‰ï¼š
    python pest_report_extractor.py

  å‘½ä»¤è¡Œæ¨¡å¼ï¼ˆæŒ‡å®šPDFæ–‡ä»¶ï¼‰ï¼š
    python pest_report_extractor.py --pdf report.pdf

  å‘½ä»¤è¡Œæ¨¡å¼ï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰ï¼š
    python pest_report_extractor.py --pdf report.pdf --report

  å‘½ä»¤è¡Œæ¨¡å¼ï¼ˆæŒ‡å®šè¾“å‡ºç›®å½•å¹¶è‡ªåŠ¨æ‰“å¼€ï¼‰ï¼š
    python pest_report_extractor.py --pdf report.pdf --output ~/Desktop --report --open
        """
    )
    
    parser.add_argument('--pdf', type=str, help='PDFæ–‡ä»¶è·¯å¾„')
    parser.add_argument('--output', type=str, help='è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ä¸ºæ¡Œé¢ï¼‰')
    parser.add_argument('--open', action='store_true', help='ç”Ÿæˆåè‡ªåŠ¨æ‰“å¼€Excelæ–‡ä»¶')
    parser.add_argument('--report', action='store_true', help='ç”Ÿæˆæ•°æ®åˆ†ææŠ¥å‘Š')
    
    args = parser.parse_args()
    
    try:
        extractor = PestReportExtractor()
        
        # å¦‚æœæ²¡æœ‰æä¾›PDFå‚æ•°ä¸”æ²¡æœ‰GUIï¼Œåˆ™æç¤ºç”¨æ³•
        if args.pdf is None and not HAS_GUI:
            print("âŒ é”™è¯¯ï¼šå‘½ä»¤è¡Œæ¨¡å¼éœ€è¦æŒ‡å®šPDFæ–‡ä»¶")
            print("\nä½¿ç”¨æ–¹æ³•ï¼š")
            print("  python pest_report_extractor.py --pdf <pdfæ–‡ä»¶è·¯å¾„>")
            print("\nç¤ºä¾‹ï¼š")
            print("  python pest_report_extractor.py --pdf report.pdf --output ~/Desktop --report")
            return
        
        success = extractor.run(
            pdf_path=args.pdf,
            output_dir=args.output,
            auto_open=args.open,
            generate_report=args.report
        )
        
        if not success:
            sys.exit(1)
            
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­æ“ä½œ")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ ç¨‹åºè¿è¡Œå‡ºé”™: {str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
